#!/bin/sh

previous=$1         # The ref of the previous HEAD
current=$2          # The ref of the new HEAD (which may or may not have changed)
branch_checkout=$3  # A flag indicating whether the checkout was a branch checkout

echo "post checkout $previous"

trigger_bundler() {
  [ -f Gemfile ] && [ "$(git diff --name-only $previous Gemfile Gemfile.lock)" ]
}

trigger_migrations() {
  [ -f "db/schema.rb" ] && [ "$(git diff --diff-filter=A --name-only $previous db/migrate)" ]
}

trigger_yarn() {
  [ -f package.json ] && [ "$(git diff --name-only $previous package.json yarn.lock)" ]
}

summarize_updates() {
  if !trigger_bundler && !trigger_migrations && !trigger_yarn
  then
    echo "no updates"
    return
  fi

  echo "Here's a summary of the changes you just pulled..."

  if trigger_bundler
  then
    echo "üíé Bundler"
  fi

  if trigger_yarn
  then
    echo "üì¶ NPM packages..."
  fi

  if trigger_migrations
  then
    echo "‚ö°Ô∏è DB Migrations..."
  fi

  echo "‚ú® Be sure to run rup or bin/update"
}

if [ $branch_checkout == 1 ]
then
  summarize_updates
fi
